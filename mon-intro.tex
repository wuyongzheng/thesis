\rule{\textwidth}{1pt}
{\em
This chapters shows our two monitoring infrastructures ---
LBox\cite{wu2005user} and WinResMon\cite{ramnath2006winresmon}.
They will be used as the underlying monitoring systems for our other works
in later chapters.
}\\
\rule{\textwidth}{1pt}
\medskip

System monitoring is an important task on ensuring a correct running
system.
It can be used to confirm or verify the correctness of a running system;
diagnose system failure;
identify performance problems;
and find security problems.
As system grows larger and more complicated, these tasks becomes more challenging.

A general monitoring infrastructure needs to be
{\em correct}, {\em secure}, {\em transparent}, {\em flexible}, and {\em efficient}.
By {\em correct}, the monitored events must be sound and complete, i.e.
no events should be missed, duplicated or invented.
In some situation, events can be generated faster than the monitor can handle.
In this case, a choice must be made to either discard the events
or suspend the monitored program.
When we monitor for security purpose, the latter is preferred.
However, this could affect the monitored software and sometimes may even
cause dead lock.
The Solaris DTrace (Sec.~\ref{sec:dtrace}) adopts the former for the
reliability and performance of the monitored software.
We believe that a monitoring system should let the user make the choice,
because different scenarios may have different trade-off.

\TODO{transparent: fully transparent may not be achievelable.
focus on functional transprency
%http://en.wikipedia.org/wiki/Popek_and_Goldberg_virtualization_requirements
}.

The monitoring infrastructure need to be {\em secure} in both design and implementation.
For example, it should not leak confidential information to low privilege users.
It should be carefully implemented so that a malicious monitored
software would not exploit the infrastructure.


By {\em flexible}, the infrastructure should be sufficiently general to
handle different problems.
For example, an API can be used to extend the monitored events for future software.
A filter language can be used pre-process events.

By {\em efficient}, the infrastructure should not introduce too much
overhead on the monitored software.
An observer is part of the system and changes the system, similarly,
a monitor can bring side effects to the monitored program.
Too much overhead not only slows the system down, but may also make
it incorrect.

In this chapter, we start by giving some background of monitoring techniques
and show some related work.
We then propose two general monitoring infrastructures.
The LBox addresses the problem of {\em user-level} monitoring.
Most traditional monitoring infrastructures are super-user based,
mainly because they are system-wide.
With user-level monitoring, LBox can be used by all users in a multi-user
system, moreover, LBox allows monitor to be recursive.
However, this poses several new challenges such as
user isolation, information confinement, and infinite event looping.
The work has been published in \cite{wu2005user}.

Our second monitoring infrastructures, WinResMon addresses the problem
of extensible resource-based monitoring in Windows.
In open source operating systems such as Linux,
both the internal design and system call API are understandable by
the developer, thus system based monitoring makes sense.
However, as we discussed in Section~\ref{sec:bg-win},
in Windows, the native calls are not documented and continuously
changing.
Though it is possible to monitor native calls, the output would not be
generally understandable.
WinResMon addresses the problem from a resource usage point of view.
It monitors resource usage of all processes in the system.
Its main use is to inspect resource access and software dependency issues.
As an infrastructure, it can be used to build tools for custom queries
for system administrators.
Our benchmarking shows that WinResMon is reliable and is
comparable to other popular tools.
The work was published in \cite{ramnath2006winresmon}.
After that, several enhancements have been implemented in order to support
our later work.
